name: PPA smoke

on:
  workflow_dispatch:
    inputs:
      ppa:
        description: "Launchpad PPA in owner/name form"
        required: true
        default: "abrekhov/hypertunnel"
      package:
        description: "Debian package name to install"
        required: true
        default: "hypertunnel"

jobs:
  install-and-run:
    runs-on: ubuntu-24.04
    steps:
      - name: Install prerequisites
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            software-properties-common

      - name: Add PPA
        run: |
          set -euo pipefail
          sudo add-apt-repository -y "ppa:${{ inputs.ppa }}"

      - name: Install package
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y "${{ inputs.package }}"

      - name: Smoke test
        run: |
          set -euo pipefail
          command -v ht
          ht --help >/dev/null
          tmpdir="$(mktemp -d)"
          printf 'hello\n' > "${tmpdir}/msg.txt"
          ht encrypt -k "test" "${tmpdir}/msg.txt"
          ht decrypt -k "test" "${tmpdir}/msg.txt.enc"
          test -f "${tmpdir}/msg.txt.dec"
